<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è¨ºæ–­çµæœ | å“²å­¦æ€§æ ¼è¨ºæ–­</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="quizContainer">
    <div class="result-title">ã‚ãªãŸã«åˆã†å“²å­¦è€…ã¯â€¦</div>
    <div id="result"></div>

    <div class="controls">
      <!-- åˆæœŸçŠ¶æ…‹ã§ã¯ã€Œã‚‚ã†ä¸€åº¦è¨ºæ–­ã™ã‚‹ã€ã ã‘ -->
      <button onclick="location.href='quiz.html'">ã‚‚ã†ä¸€åº¦è¨ºæ–­ã™ã‚‹</button>
    </div>
  </div>

  <!-- ===== ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ ===== -->
  <script src="data/philosophers.js"></script>

  <script>
    const FORCE_TOP = ""; // ãƒ†ã‚¹ãƒˆç”¨
    const resultDiv = document.getElementById("result");

    // ===== ãƒ¡ã‚¤ãƒ³æç”» =====
    function renderResult() {
      try {
        const P = PHILOSOPHERS;
        document.querySelector(".result-title").style.display = "block"; // ã‚¿ã‚¤ãƒˆãƒ«å†è¡¨ç¤º

        // ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢æ›´æ–°ï¼ˆã‚·ã‚§ã‚¢ï¼‹ã‚‚ã†ä¸€åº¦è¨ºæ–­ï¼‰
        const controls = document.querySelector(".controls");
        controls.innerHTML = `
          <button id="shareBtn">Xã§ã‚·ã‚§ã‚¢ã™ã‚‹</button>
          <button onclick="location.href='quiz.html'">ã‚‚ã†ä¸€åº¦è¨ºæ–­ã™ã‚‹</button>
        `;

        // localStorageã‹ã‚‰ã‚¹ã‚³ã‚¢å–å¾—ï¼ˆãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚ã‚Šï¼‰
        let scores = {};
        try {
          scores = JSON.parse(localStorage.getItem("quizScores")) || {};
        } catch {
          scores = {};
        }
        if (Object.keys(scores).length === 0) {
          scores = { "ã‚«ãƒ³ãƒˆ": 120, "ã‚¢ãƒªã‚¹ãƒˆãƒ†ãƒ¬ã‚¹": 110, "ãƒ‹ãƒ¼ãƒã‚§": 95 };
        }

        // ===== ã‚¹ã‚³ã‚¢ã‚’ã‚½ãƒ¼ãƒˆã—ã¦ä¸Šä½3åå–å¾—ï¼ˆåŒç‚¹æ™‚å„ªå…ˆé †ä½ã‚ã‚Šï¼‰ =====
        const priorityOrder = [
          "ã‚«ãƒ³ãƒˆ","ã‚¢ãƒªã‚¹ãƒˆãƒ†ãƒ¬ã‚¹","ã‚½ã‚¯ãƒ©ãƒ†ã‚¹ãƒ»ãƒ—ãƒ©ãƒˆãƒ³","ãƒ‡ã‚«ãƒ«ãƒˆ","ãƒ‹ãƒ¼ãƒã‚§","ã‚µãƒ«ãƒˆãƒ«",
          "ãƒ™ãƒ«ã‚¯ã‚½ãƒ³","ãƒ’ãƒ¥ãƒ¼ãƒ ","ã‚¹ãƒ”ãƒã‚¶","ã‚®ãƒªã‚·ã‚¢æ‡ç–‘æ´¾","ãƒã‚¤ãƒ‡ã‚¬ãƒ¼","ãƒ´ã‚£ãƒˆã‚²ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³",
          "ãƒ˜ãƒ¼ã‚²ãƒ«","ãƒ©ã‚¤ãƒ—ãƒ‹ãƒƒãƒ„","ãƒˆãƒã‚¹ãƒ»ã‚¢ã‚¯ã‚£ãƒŠã‚¹"
        ];

        const sorted = Object.entries(scores).sort((a, b) => {
          const diff = b[1] - a[1];
          if (diff !== 0) return diff;
          return priorityOrder.indexOf(a[0]) - priorityOrder.indexOf(b[0]);
        });

        const topThree = sorted.slice(0, 3);
        const maxScore = topThree[0] ? topThree[0][1] : 1;

        // ===== ãƒ™ã‚¹ãƒˆ3HTML =====
        let topThreeHTML = `
          <div class="ranking">
            <h3>ã‚ãªãŸã«åˆã†å“²å­¦è€…ãƒ™ã‚¹ãƒˆ3</h3>
            <ul>
              ${topThree
                .map(([name, score], index) => {
                  const percent = Math.round((score / maxScore) * 100);
                  const medal = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰"][index] || "";
                  return `
                    <li>
                      <span class="rank">${medal}</span>
                      <span class="philosopher">${name}</span>
                      <span class="percent">${percent}%</span>
                    </li>`;
                })
                .join("")}
            </ul>
          </div>`;

        // ===== ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ =====
        topThreeHTML += `
          <div class="accordion">
            <div class="accordion-inner">
              <button class="accordion-btn">ã™ã¹ã¦ã®å“²å­¦è€…ã‚’è¦‹ã‚‹ â–¼</button>
              <div class="accordion-content">
                <ul class="philosopher-list">
                  ${Object.keys(P)
                    .map(
                      (name) =>
                        `<li class="accordion-item" data-name="${name}">${name}</li>`
                    )
                    .join("")}
                </ul>
              </div>
            </div>
          </div>`;

        // ===== ãƒ¡ã‚¤ãƒ³å“²å­¦è€…ãƒ‡ãƒ¼ã‚¿ =====
        const topKey = FORCE_TOP || (sorted[0] ? sorted[0][0] : "ã‚«ãƒ³ãƒˆ");
        const p = P[topKey];
        if (!p) {
          resultDiv.innerHTML = `<p>ã€Œ${topKey}ã€ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>`;
          return;
        }

        // æ›¸ç±ãƒªã‚¹ãƒˆHTMLç”Ÿæˆï¼ˆğŸ“–ãƒãƒ¼ã‚¯ä»˜ãï¼‰
        const bookListHTML = (p.books || [])
          .map(
            (b) =>
              typeof b === "object"
                ? `<li class="book-item">ğŸ“– ${b.title}${
                    b.note ? `<small class='note'>${b.note}</small>` : ""
                  }</li>`
                : `<li class="book-item">ğŸ“– ${b}</li>`
          )
          .join("");

        // ===== çµæœå…¨ä½“HTMLå‡ºåŠ› =====
        resultDiv.innerHTML = `
          <div class="name">${p.displayName}</div>
          <img class="img" src="${p.image}" alt="${p.displayName}">
          <blockquote class="quote">â€œ${p.quote}â€</blockquote>

          <div class="diagnosis-section">
            <h3>äººç‰©ç´¹ä»‹</h3>
            <p>${p.description}</p>
            <h3>ã‚ãªãŸã®ã‚¿ã‚¤ãƒ—</h3>
            <h4 class="type-title">${p.typeTitle}</h4>
            <p>${p.typeText}</p>
            <h3>ãŠã™ã™ã‚ã®æœ¬</h3>
            <ul>${bookListHTML}</ul>
          </div>

          ${topThreeHTML}
        `;

        // ===== ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² =====
        document.querySelector(".accordion-btn").addEventListener("click", (e) => {
          const content = e.target.nextElementSibling;
          content.classList.toggle("active");
          e.target.textContent = content.classList.contains("active")
            ? "é–‰ã˜ã‚‹ â–²"
            : "ã™ã¹ã¦ã®å“²å­¦è€…ã‚’è¦‹ã‚‹ â–¼";
        });

        document.querySelectorAll(".accordion-item").forEach((item) => {
          item.addEventListener("click", () => {
            const name = item.dataset.name;
            if (P[name]) renderPhilosopher(name, P);
          });
        });
      } catch (err) {
        console.error("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
        resultDiv.innerHTML = `<p style="color:red;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ: ${err.message}</p>`;
      }
    }

    // ===== ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ï¼ˆXï¼‰ =====
    document.addEventListener("click", (e) => {
      if (e.target.id === "shareBtn") {
        const philosopher = document.querySelector(".name")?.textContent || "å“²å­¦è€…";
        const text = `ç§ã«åˆã†å“²å­¦è€…ã¯ã€Œ${philosopher}ã€ã§ã—ãŸï¼ğŸ§ âœ¨\n#å“²å­¦æ€§æ ¼è¨ºæ–­ #PhilosophyQuiz`;
        const url = location.origin + location.pathname;
        const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
        window.open(twitterUrl, "_blank");
      }
    });

    // ===== åˆ¥ã®å“²å­¦è€…ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®åˆ‡ã‚Šæ›¿ãˆ =====
    function renderPhilosopher(name, P) {
      const p = P[name];
      if (!p) return;

      const bookListHTML = (p.books || [])
        .map(b =>
          typeof b === "object"
            ? `<li class="book-item">ğŸ“– ${b.title}${b.note ? `<br><small class='note'>${b.note}</small>` : ""}</li>`
            : `<li class="book-item">ğŸ“– ${b}</li>`
        )
        .join("");

      const accordionHTML = `
        <div class="accordion">
          <div class="accordion-inner">
            <button class="accordion-btn">ã™ã¹ã¦ã®å“²å­¦è€…ã‚’è¦‹ã‚‹ â–¼</button>
            <div class="accordion-content">
              <ul class="philosopher-list">
                ${Object.keys(P)
                  .map(name => `<li class="accordion-item">${name}</li>`)
                  .join("")}
              </ul>
            </div>
          </div>
        </div>`;

      document.querySelector(".result-title").style.display = "none";

      // ===== ã€Œã‚ãªãŸã®ã‚¿ã‚¤ãƒ—ã€â†’ã€Œå“²å­¦çš„æ€§æ ¼ã€ã«å¤‰æ›´ =====
      resultDiv.innerHTML = `
        <div class="name">${p.displayName}</div>
        <img class="img" src="${p.image}" alt="${p.displayName}">
        <blockquote class="quote">â€œ${p.quote}â€</blockquote>
        <h3>äººç‰©ç´¹ä»‹</h3>
        <p>${p.description}</p>
        <h3>å“²å­¦çš„æ€§æ ¼</h3>  <!-- â† ã“ã“ã‚’åˆ‡ã‚Šæ›¿ãˆ -->
        <h4 class="type-title">${p.typeTitle}</h4>
        <p>${p.typeText}</p>
        <h3>ãŠã™ã™ã‚ã®æœ¬</h3>
        <ul>${bookListHTML}</ul>
        ${accordionHTML}
      `;

      const controls = document.querySelector(".controls");
      controls.innerHTML = `
        <button onclick="renderResult()">è¨ºæ–­çµæœã«æˆ»ã‚‹</button>
       <button onclick="location.href='quiz.html'">ã‚‚ã†ä¸€åº¦è¨ºæ–­ã™ã‚‹</button>
      `;

      const accordionBtn = document.querySelector(".accordion-btn");
      accordionBtn.addEventListener("click", (e) => {
        const content = e.target.nextElementSibling;
        content.classList.toggle("active");
        e.target.textContent = content.classList.contains("active")
          ? "é–‰ã˜ã‚‹ â–²"
          : "ã™ã¹ã¦ã®å“²å­¦è€…ã‚’è¦‹ã‚‹ â–¼";
      });

      document.querySelectorAll(".accordion-item").forEach(item => {
        item.addEventListener("click", () => {
          const name = item.textContent.trim();
          if (P[name]) renderPhilosopher(name, P);
        });
      });

      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    renderResult();
  </script>

  <!-- ===== ãƒ•ãƒƒã‚¿ãƒ¼ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ ===== -->
  <footer class="credit">
    ã“ã®è¨ºæ–­ã‚’ä½œã£ãŸã²ã¨ã¯
    <a href="https://x.com/tuttle_spoon?s=21&t=xzsJDzYWmXj9INURNIm5vQ" target="_blank" rel="noopener noreferrer" class="credit-link">
      <strong>ã‚¿ãƒƒãƒˆãƒ«</strong>
      <img src="images/tuttle_icon.jpg" alt="ã‚¿ãƒƒãƒˆãƒ«" class="credit-icon">
    </a>
  </footer>

  <script type="module">
    // Firebase SDKã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
  
    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyDwwjCX_-EHPusTrmRQIdAAgv8Z1yf81Wc",
      authDomain: "philosophy-quiz-783ca.firebaseapp.com",
      databaseURL: "https://philosophy-quiz-783ca-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "philosophy-quiz-783ca",
      storageBucket: "philosophy-quiz-783ca.firebasestorage.app",
      messagingSenderId: "582830530333",
      appId: "1:582830530333:web:ea492642c2d3b798568bf4",
      measurementId: "G-5MJ4040RQM"
    };
  
    // FirebaseåˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const counterRef = ref(db, "counter");
  
    // ğŸŸ¢ ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼
    // ã€Œcounterã€ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã¿0ã‚’è¨­å®šï¼ˆåˆæœŸåŒ–ï¼‰
    get(counterRef).then((snapshot) => {
      if (!snapshot.exists()) {
        runTransaction(counterRef, () => 0);
      }
    });
  
    // ğŸŸ¢ ãƒšãƒ¼ã‚¸åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
    if (!sessionStorage.getItem("visited")) {
      runTransaction(counterRef, (currentValue) => (currentValue || 0) + 1);
      sessionStorage.setItem("visited", "true");
    }
  
    // ğŸŸ¢ ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¦ç´ ã‚’è¿½åŠ 
    window.addEventListener("DOMContentLoaded", () => {
      const container = document.getElementById("quizContainer");
      if (!container) {
        console.error("âŒ quizContainer ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚HTMLå´ã« <div id='quizContainer'></div> ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
  
      const counterDiv = document.createElement("div");
      counterDiv.className = "counter-container";
      counterDiv.style = "text-align: center; margin-top: 24px;";
      counterDiv.innerHTML = `<p>ğŸ“Œ ã“ã®è¨ºæ–­ã‚’å—ã‘ãŸã²ã¨ã¯ <span id="counter">0</span> äººã§ã™ï¼</p>`;
      container.appendChild(counterDiv);
  
      // ğŸŸ¢ Realtime Databaseã®å€¤ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ 
      onValue(counterRef, (snapshot) => {
        const count = snapshot.val();
        document.getElementById("counter").textContent = count ?? 0;
      });
    });
  </script>  

</body>
</html>
